services:
  # ========================================================================
  # FASTAPI RAG API
  # ========================================================================
  api:
    build:
      context: .
      dockerfile: backend/Dockerfile
    image: kpo237/cv-chatbot-api:latest
    container_name: cv-chatbot-api
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "8001:8001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ========================================================================
  # CHAINLIT UI
  # ========================================================================
  chainlit:
    image: kpo237/cv-chatbot-api:latest
    container_name: cv-chatbot-ui
    restart: unless-stopped
    depends_on:
      - api
    working_dir: /backend/app
    volumes:
      - ./app/chainlit_app.py:/app/chainlit_app.py:ro
      - ./.chainlit:/app/.chainlit
      - ./chainlit_files:/app/.files
      - ./app/chainlit.md:/app/chainlit.md:ro
    environment:
      API_BASE_URL: http://api:8001
    command: >
      bash -c "
        pip install chainlit httpx &&
        chainlit run chainlit_app.py --host 0.0.0.0 --port 8000
      "
    ports:
      - "8000:8000"
